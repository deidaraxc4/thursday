<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="Draw dogs on Thursdays">
    <meta property="og:type" content="website" />
    <meta property="og:url" content="http://ec2-3-85-41-179.compute-1.amazonaws.com/">
    <meta property="og:image" content="thursday_logo.svg" />
    <title>Draw Dog Thursday</title>
    <link rel="icon" type="image/png" href="thursday_logo.svg"/>
    <!-- add our CSS -->
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/draw.css" />
    <!-- add Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <!-- add JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body>
    <div class="navbar">
        <div class="nav">
            <a id="submit">Submit</a>
            <a id="back" href="./home">Back Home</a>
        </div>
    </div>

    <br class="break" />

    <div class="main">
        <div class="canvas-wrapper">
            <canvas id="canvas"></canvas>
        </div>
        <br />
        <div class="toolbar">
            <img id="pencil" src="assets/pencil.svg" alt="pencil">
            <img id="eraser" src="assets/eraser.svg" alt="eraser">
            <span class="size-divider">|</span>
            <span id="size-small" class="size-button" title="Small">●</span>
            <span id="size-medium" class="size-button" title="Medium">●</span>
            <span id="size-large" class="size-button" title="Large">●</span>
            <span class="size-divider">|</span>
            <div class="color-picker">
                <div class="color-grid">
                    <span class="color-dot" data-color="#000000" title="Black" style="background-color: #000000;"></span>
                    <span class="color-dot" data-color="#E63946" title="Red" style="background-color: #E63946;"></span>
                    <span class="color-dot" data-color="#F77F00" title="Orange" style="background-color: #F77F00;"></span>
                    <span class="color-dot" data-color="#FCBF49" title="Yellow" style="background-color: #FCBF49;"></span>
                    <span class="color-dot" data-color="#06A77D" title="Green" style="background-color: #06A77D;"></span>
                    <span class="color-dot" data-color="#118AB2" title="Blue" style="background-color: #118AB2;"></span>
                    <span class="color-dot" data-color="#073B4C" title="Dark Blue" style="background-color: #073B4C;"></span>
                    <span class="color-dot" data-color="#8338EC" title="Purple" style="background-color: #8338EC;"></span>
                    <span class="color-dot" data-color="#FF006E" title="Pink" style="background-color: #FF006E;"></span>
                    <span class="color-dot" data-color="#A0AEC0" title="Gray" style="background-color: #A0AEC0;"></span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.3/fabric.min.js"></script>
    <script type="text/javascript">
        var canvas;
        var width = $(document).width();
        var height = $(document).height();
        var currentSize = "medium"; // track current size
        var currentColor = "#000000"; // track current color
        var isEraserMode = false; // track if in eraser mode
        
        // bootleg mobile responsiveness
        if(width <= 479) {
            height = 512;
        } else {
            width = 512;
            height = 512;
        }

        const currentTheme = "<%=currentTheme%>";
        console.log("Current theme:", currentTheme);

        // Function to create a circle cursor based on brush width and color
        function createCircleCursor(radius, color) {
            const svg = `
                <svg width="${radius * 2}" height="${radius * 2}" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="${radius}" cy="${radius}" r="${radius - 1}" fill="none" stroke="${color}" stroke-width="1"/>
                    <circle cx="${radius}" cy="${radius}" r="1" fill="${color}"/>
                </svg>
            `;
            const dataUrl = `data:image/svg+xml;base64,${btoa(svg)}`;
            return `url('${dataUrl}') ${radius} ${radius}, auto`;
        }

        // Update canvas cursor based on current brush settings
        function updateCursor() {
            const color = isEraserMode ? "black" : currentColor;
            const radius = canvas.freeDrawingBrush.width / 2;
            const $canvas = document.getElementById('canvas');
            $canvas.style.cursor = createCircleCursor(radius, color);
        }

        $(document).ready(
            (function() {
                var $ = (id) => document.getElementById(id);

                canvas = new fabric.Canvas('canvas', {
                    isDrawingMode: true,
                    width: width,
                    height: height,
                    backgroundColor: "white",
                    imageSmoothingEnabled: false
                });
                canvas.freeDrawingBrush.width = 6;
                canvas.freeDrawingBrush.color = currentColor;
                updateCursor();

                $("submit").onclick = () => {
                    const imageDataUrl = canvas.toDataURL();
                    const data = { data: imageDataUrl, theme: currentTheme };
                    window.fetch('./draw', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    }).then(() => window.location.href = './home');
                };

            })()
        );

        // Size button styling
        function updateSizeButtons() {
            document.getElementById('size-small').style.fontSize = '10px';
            document.getElementById('size-small').style.opacity = currentSize === 'small' ? '1' : '0.3';
            
            document.getElementById('size-medium').style.fontSize = '16px';
            document.getElementById('size-medium').style.opacity = currentSize === 'medium' ? '1' : '0.3';
            
            document.getElementById('size-large').style.fontSize = '22px';
            document.getElementById('size-large').style.opacity = currentSize === 'large' ? '1' : '0.3';
        }

        // Color picker button styling
        function updateColorDots() {
            document.querySelectorAll('.color-dot').forEach(dot => {
                if (dot.getAttribute('data-color') === currentColor && !isEraserMode) {
                    dot.classList.add('selected');
                } else {
                    dot.classList.remove('selected');
                }
            });
        }

        updateSizeButtons();
        updateColorDots();

        // Eraser button
        $("#eraser").css("opacity","0.2");
        $("#eraser").click(() => {
            isEraserMode = !isEraserMode;
            
            if (isEraserMode) {
                $("#eraser").css("opacity", "1");
                $("#pencil").css("opacity", ".2");
                canvas.freeDrawingBrush.color = "white";
            } else {
                $("#eraser").css("opacity", ".2");
                $("#pencil").css("opacity", "1");
                canvas.freeDrawingBrush.color = currentColor;
            }
            
            // Apply size based on current size selection
            applyCurrentSize();
            updateCursor();
            updateColorDots();
        });

        // Pencil button
        $("#pencil").click(() => {
            isEraserMode = false;
            $("#pencil").css("opacity", "1");
            $("#eraser").css("opacity", ".2");
            canvas.freeDrawingBrush.color = currentColor;
            
            // Apply size based on current size selection
            applyCurrentSize();
            updateCursor();
            updateColorDots();
        });

        // Helper function to apply current size
        function applyCurrentSize() {
            if (isEraserMode) {
                if(currentSize === 'small') {
                    canvas.freeDrawingBrush.width = 10;
                } else if(currentSize === 'medium') {
                    canvas.freeDrawingBrush.width = 20;
                } else {
                    canvas.freeDrawingBrush.width = 40;
                }
            } else {
                if(currentSize === 'small') {
                    canvas.freeDrawingBrush.width = 3;
                } else if(currentSize === 'medium') {
                    canvas.freeDrawingBrush.width = 6;
                } else {
                    canvas.freeDrawingBrush.width = 12;
                }
            }
        }

        // Size buttons
        $("#size-small").click(() => {
            currentSize = 'small';
            updateSizeButtons();
            applyCurrentSize();
            updateCursor();
        });

        $("#size-medium").click(() => {
            currentSize = 'medium';
            updateSizeButtons();
            applyCurrentSize();
            updateCursor();
        });

        $("#size-large").click(() => {
            currentSize = 'large';
            updateSizeButtons();
            applyCurrentSize();
            updateCursor();
        });

        // Color picker dots
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.addEventListener('click', () => {
                currentColor = dot.getAttribute('data-color');
                
                // Switch to pencil mode (not eraser) when picking a color
                if (isEraserMode) {
                    isEraserMode = false;
                    $("#pencil").css("opacity", "1");
                    $("#eraser").css("opacity", ".2");
                }
                
                canvas.freeDrawingBrush.color = currentColor;
                applyCurrentSize();
                updateCursor();
                updateColorDots();
            });
        });

    </script>

</body>

</html>